name: Bump Version

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  bump-version:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Compute new version
        id: version
        run: |
          FILE="Sources/fxios/Core/Configuration.swift"

          # Extract current version
          current=$(awk -F'"' '$0 ~ /static[[:space:]]+let[[:space:]]+version[[:space:]]*=/ { if (NF >= 2) { print $2; exit } }' "$FILE")
          if [[ -z "$current" ]]; then
            echo "Error: could not find version line in $FILE"
            exit 1
          fi
          echo "Current version: $current"

          # Compute new version (YYYYMMDD.N format)
          today=$(date +%Y%m%d)
          if [[ "$current" =~ ^([0-9]{8})\.([0-9]+)$ ]]; then
            base="${BASH_REMATCH[1]}"
            minor="${BASH_REMATCH[2]}"
            if [[ "$base" == "$today" ]]; then
              new="${today}.$((minor + 1))"
            else
              new="${today}.0"
            fi
          else
            new="${today}.0"
          fi

          if [[ "$new" == "$current" ]]; then
            echo "Error: version already '$current' (no change)"
            exit 1
          fi

          echo "new=$new" >> "$GITHUB_OUTPUT"
          echo "New version: $new"

      - name: Create release branch and PR
        env:
          GH_TOKEN: ${{ github.token }}
          NEW_VERSION: ${{ steps.version.outputs.new }}
        run: |
          FILE="Sources/fxios/Core/Configuration.swift"
          BRANCH="release/v${NEW_VERSION}"

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Create branch
          git checkout -b "$BRANCH"

          # Update file
          sed -i -E "s/(static[[:space:]]+let[[:space:]]+version[[:space:]]*=[[:space:]]*\")([^\"]+)(\")/\1${NEW_VERSION}\3/" "$FILE"

          # Verify update
          updated=$(awk -F'"' '$0 ~ /static[[:space:]]+let[[:space:]]+version[[:space:]]*=/ { if (NF >= 2) { print $2; exit } }' "$FILE")
          if [[ "$updated" != "$NEW_VERSION" ]]; then
            echo "Error: failed to update version (still '$updated')"
            exit 1
          fi

          # Commit and push
          git add "$FILE"
          git commit -m "Release v${NEW_VERSION}"
          git push origin "$BRANCH"

          # Create PR
          gh pr create \
            --title "Release v${NEW_VERSION}" \
            --body "Bumps version to \`${NEW_VERSION}\`.

          Merging this PR will automatically create the \`v${NEW_VERSION}\` tag and trigger the release workflow." \
            --base main \
            --head "$BRANCH"
